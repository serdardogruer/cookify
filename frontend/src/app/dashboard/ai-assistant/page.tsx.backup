'use client';

import { useState, useEffect } from 'react';
import { toast } from 'react-hot-toast';
import DashboardHeader from '@/components/DashboardHeader';

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:5000';

interface AIIntegration {
  id: number;
  provider: string;
  model: string | null;
  isActive: boolean;
  createdAt: string;
}

const AI_PROVIDERS = [
  { 
    id: 'openai', 
    name: 'OpenAI', 
    icon: 'ðŸ¤–',
    models: ['gpt-4', 'gpt-3.5-turbo', 'gpt-4-turbo'],
    description: 'Tarif Ã¶nerileri, malzeme tanÄ±ma'
  },
  { 
    id: 'gemini', 
    name: 'Google Gemini', 
    icon: 'âœ¨',
    models: ['gemini-pro', 'gemini-pro-vision'],
    description: 'GÃ¶rsel analiz, tarif Ã¶nerileri'
  },
  { 
    id: 'anthropic', 
    name: 'Claude (Anthropic)', 
    icon: 'ðŸ§ ',
    models: ['claude-3-opus', 'claude-3-sonnet'],
    description: 'DetaylÄ± tarif aÃ§Ä±klamalarÄ±'
  },
];

export default function AIAssistantPage() {
  const [integrations, setIntegrations] = useState<AIIntegration[]>([]);
  const [loading, setLoading] = useState(true);
  const [showAddModal, setShowAddModal] = useState(false);
  const [selectedProvider, setSelectedProvider] = useState('');
  const [apiKey, setApiKey] = useState('');
  const [selectedModel, setSelectedModel] = useState('');
  const [activeTab, setActiveTab] = useState<'recipe' | 'settings'>('recipe');
  
  // Tarif Ã¶nerisi iÃ§in
  const [ingredients, setIngredients] = useState<string[]>([]);
  const [newIngredient, setNewIngredient] = useState('');
  const [suggestions, setSuggestions] = useState('');
  const [loadingSuggestions, setLoadingSuggestions] = useState(false);

  useEffect(() => {
    loadIntegrations();
  }, []);

  const loadIntegrations = async () => {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_URL}/api/ai/integrations`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await response.json();
      if (data.success) {
        // KullanÄ±cÄ±nÄ±n kendi entegrasyonlarÄ±
        const userIntegrations = data.integrations || [];
        
        // EÄŸer hiÃ§ entegrasyon yoksa, Ã¼cretsiz Gemini'yi gÃ¶ster
        if (userIntegrations.length === 0) {
          setIntegrations([
            {
              id: 0,
              provider: 'gemini',
              model: 'gemini-pro',
              isActive: true,
              createdAt: new Date().toISOString(),
              isFree: true, // Ãœcretsiz olduÄŸunu iÅŸaretle
            }
          ]);
        } else {
          setIntegrations(userIntegrations);
        }
      }
    } catch (error) {
      console.error('AI entegrasyonlarÄ± yÃ¼kleme hatasÄ±:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleAddIntegration = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!selectedProvider || !apiKey) {
      toast.error('LÃ¼tfen tÃ¼m alanlarÄ± doldurun');
      return;
    }

    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_URL}/api/ai/integrations`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({
          provider: selectedProvider,
          apiKey,
          model: selectedModel || null
        })
      });

      const data = await response.json();
      
      if (data.success) {
        toast.success('AI entegrasyonu eklendi');
        setShowAddModal(false);
        setSelectedProvider('');
        setApiKey('');
        setSelectedModel('');
        loadIntegrations();
      } else {
        toast.error(data.message || 'Hata oluÅŸtu');
      }
    } catch (error) {
      console.error('AI entegrasyonu ekleme hatasÄ±:', error);
      toast.error('Bir hata oluÅŸtu');
    }
  };

  const handleToggleActive = async (id: number, isActive: boolean) => {
    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_URL}/api/ai/integrations/${id}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ isActive: !isActive })
      });

      const data = await response.json();
      
      if (data.success) {
        toast.success(isActive ? 'Devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±' : 'Aktif edildi');
        loadIntegrations();
      }
    } catch (error) {
      console.error('AI entegrasyonu gÃ¼ncelleme hatasÄ±:', error);
      toast.error('Bir hata oluÅŸtu');
    }
  };

  const handleDelete = async (id: number) => {
    if (!confirm('Bu AI entegrasyonunu silmek istediÄŸinize emin misiniz?')) {
      return;
    }

    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_URL}/api/ai/integrations/${id}`, {
        method: 'DELETE',
        headers: { Authorization: `Bearer ${token}` }
      });

      const data = await response.json();
      
      if (data.success) {
        toast.success('AI entegrasyonu silindi');
        loadIntegrations();
      }
    } catch (error) {
      console.error('AI entegrasyonu silme hatasÄ±:', error);
      toast.error('Bir hata oluÅŸtu');
    }
  };

  const getProviderInfo = (provider: string) => {
    return AI_PROVIDERS.find(p => p.id === provider);
  };

  const handleAddIngredient = () => {
    if (newIngredient.trim()) {
      setIngredients([...ingredients, newIngredient.trim()]);
      setNewIngredient('');
    }
  };

  const handleRemoveIngredient = (index: number) => {
    setIngredients(ingredients.filter((_, i) => i !== index));
  };

  const handleGetSuggestions = async () => {
    if (ingredients.length === 0) {
      toast.error('LÃ¼tfen en az bir malzeme ekleyin');
      return;
    }

    setLoadingSuggestions(true);
    setSuggestions('');

    try {
      const token = localStorage.getItem('token');
      const response = await fetch(`${API_URL}/api/ai/recipe-suggestions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: `Bearer ${token}`
        },
        body: JSON.stringify({ ingredients })
      });

      const data = await response.json();

      if (data.success) {
        setSuggestions(data.suggestions);
        toast.success('Tarif Ã¶nerileri alÄ±ndÄ±!');
      } else {
        toast.error(data.message || 'Bir hata oluÅŸtu');
      }
    } catch (error) {
      console.error('Tarif Ã¶nerisi hatasÄ±:', error);
      toast.error('Bir hata oluÅŸtu');
    } finally {
      setLoadingSuggestions(false);
    }
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-[#111111]">
        <DashboardHeader />
        <div className="flex items-center justify-center h-[calc(100vh-80px)]">
          <div className="text-white">YÃ¼kleniyor...</div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#111111]">
      <DashboardHeader />
      
      <div className="container mx-auto px-4 py-8 max-w-6xl">
        {/* Header */}
        <div className="mb-8">
          <h1 className="text-white text-3xl font-bold mb-2">ðŸ¤– AI Asistan</h1>
          <p className="text-[#A0A0A0]">
            Yapay zeka ile akÄ±llÄ± tarif Ã¶nerileri alÄ±n
          </p>
        </div>

        {/* Tabs */}
        <div className="flex gap-4 mb-8 border-b border-white/10">
          <button
            onClick={() => setActiveTab('recipe')}
            className={`pb-4 px-2 font-medium transition-colors relative ${
              activeTab === 'recipe'
                ? 'text-[#30D158]'
                : 'text-[#A0A0A0] hover:text-white'
            }`}
          >
            Tarif Ã–nerisi
            {activeTab === 'recipe' && (
              <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-[#30D158]" />
            )}
          </button>
          <button
            onClick={() => setActiveTab('settings')}
            className={`pb-4 px-2 font-medium transition-colors relative ${
              activeTab === 'settings'
                ? 'text-[#30D158]'
                : 'text-[#A0A0A0] hover:text-white'
            }`}
          >
            AI AyarlarÄ±
            {activeTab === 'settings' && (
              <div className="absolute bottom-0 left-0 right-0 h-0.5 bg-[#30D158]" />
            )}
          </button>
        </div>

        {/* Tab: Tarif Ã–nerisi */}
        {activeTab === 'recipe' && (
          <div className="space-y-6">
            {/* Malzeme Ekleme */}
            <div className="bg-[#1E1E1E] rounded-xl p-6">
              <h2 className="text-white text-xl font-bold mb-4">Malzemeleriniz</h2>
              <div className="flex gap-3 mb-4">
                <input
                  type="text"
                  value={newIngredient}
                  onChange={(e) => setNewIngredient(e.target.value)}
                  onKeyPress={(e) => e.key === 'Enter' && handleAddIngredient()}
                  placeholder="Malzeme ekle (Ã¶rn: domates, soÄŸan)"
                  className="flex-1 bg-[#2C2C2C] text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#30D158]"
                />
                <button
                  onClick={handleAddIngredient}
                  className="bg-[#30D158] text-white px-6 py-3 rounded-lg font-medium hover:bg-[#28a745] transition"
                >
                  Ekle
                </button>
              </div>

              {/* Malzeme Listesi */}
              {ingredients.length > 0 && (
                <div className="flex flex-wrap gap-2">
                  {ingredients.map((ingredient, index) => (
                    <div
                      key={index}
                      className="bg-[#2C2C2C] text-white px-4 py-2 rounded-lg flex items-center gap-2"
                    >
                      <span>{ingredient}</span>
                      <button
                        onClick={() => handleRemoveIngredient(index)}
                        className="text-red-500 hover:text-red-400"
                      >
                        Ã—
                      </button>
                    </div>
                  ))}
                </div>
              )}

              {/* Ã–neri Al Butonu */}
              <button
                onClick={handleGetSuggestions}
                disabled={loadingSuggestions || ingredients.length === 0}
                className="w-full mt-6 bg-[#30D158] text-white py-4 rounded-xl font-bold hover:bg-[#28a745] transition disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {loadingSuggestions ? 'AI dÃ¼ÅŸÃ¼nÃ¼yor...' : 'âœ¨ Tarif Ã–nerisi Al'}
              </button>
            </div>

            {/* Ã–neriler */}
            {suggestions && (
              <div className="bg-[#1E1E1E] rounded-xl p-6">
                <h2 className="text-white text-xl font-bold mb-4">AI Ã–nerileri</h2>
                <div className="text-[#A0A0A0] whitespace-pre-wrap leading-relaxed">
                  {suggestions}
                </div>
              </div>
            )}
          </div>
        )}

        {/* Tab: AI AyarlarÄ± */}
        {activeTab === 'settings' && (
          <div>
            <div className="flex items-center justify-between mb-6">
              <div>
                <h2 className="text-white text-xl font-bold mb-2">AI EntegrasyonlarÄ±</h2>
                <p className="text-[#A0A0A0]">
                  Kendi yapay zeka API'lerinizi entegre edin
                </p>
              </div>
              <button
                onClick={() => setShowAddModal(true)}
                className="bg-[#30D158] text-white px-6 py-3 rounded-xl font-medium hover:bg-[#28a745] transition"
              >
                + AI Ekle
              </button>
            </div>

        {/* Entegrasyonlar */}
        {integrations.length === 0 ? (
          <div className="bg-[#1E1E1E] rounded-xl p-8 text-center">
            <div className="text-6xl mb-4">ðŸ¤–</div>
            <h3 className="text-white text-xl font-bold mb-2">
              HenÃ¼z AI entegrasyonu yok
            </h3>
            <p className="text-[#A0A0A0] mb-6">
              Kendi OpenAI, Gemini veya Claude API anahtarÄ±nÄ±zÄ± ekleyerek baÅŸlayÄ±n
            </p>
            <button
              onClick={() => setShowAddModal(true)}
              className="bg-[#30D158] text-white px-6 py-3 rounded-xl font-medium hover:bg-[#28a745] transition"
            >
              Ä°lk AI'Ä± Ekle
            </button>
          </div>
        ) : (
          <div className="grid gap-4">
            {integrations.map((integration) => {
              const providerInfo = getProviderInfo(integration.provider);
              const isFree = (integration as any).isFree;
              
              return (
                <div
                  key={integration.id}
                  className={`bg-[#1E1E1E] rounded-xl p-6 flex items-center justify-between ${
                    isFree ? 'border-2 border-[#30D158]' : ''
                  }`}
                >
                  <div className="flex items-center gap-4">
                    <div className="text-4xl">{providerInfo?.icon}</div>
                    <div>
                      <div className="flex items-center gap-2">
                        <h3 className="text-white text-lg font-bold">
                          {providerInfo?.name}
                        </h3>
                        {isFree && (
                          <span className="bg-[#30D158] text-[#121212] text-xs font-bold px-2 py-1 rounded">
                            ÃœCRETSÄ°Z
                          </span>
                        )}
                      </div>
                      <p className="text-[#A0A0A0] text-sm">
                        {integration.model || 'Model seÃ§ilmedi'}
                      </p>
                      <p className="text-[#666] text-xs mt-1">
                        {isFree 
                          ? 'Cookify tarafÄ±ndan saÄŸlanan Ã¼cretsiz AI hizmeti' 
                          : providerInfo?.description
                        }
                      </p>
                    </div>
                  </div>
                  <div className="flex items-center gap-3">
                    {!isFree && (
                      <>
                        <button
                          onClick={() => handleToggleActive(integration.id, integration.isActive)}
                          className={`px-4 py-2 rounded-lg font-medium transition ${
                            integration.isActive
                              ? 'bg-[#30D158] text-white'
                              : 'bg-[#2C2C2C] text-[#A0A0A0]'
                          }`}
                        >
                          {integration.isActive ? 'Aktif' : 'Pasif'}
                        </button>
                        <button
                          onClick={() => handleDelete(integration.id)}
                          className="text-red-500 hover:text-red-400 transition"
                        >
                          <span className="material-symbols-outlined">delete</span>
                        </button>
                      </>
                    )}
                    {isFree && (
                      <div className="text-[#30D158] text-sm font-medium">
                        âœ“ VarsayÄ±lan AI
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        )}

            {/* Bilgi KartlarÄ± */}
            <div className="grid md:grid-cols-3 gap-4 mt-8">
          <div className="bg-[#1E1E1E] rounded-xl p-6">
            <div className="text-3xl mb-3">ðŸ”’</div>
            <h3 className="text-white font-bold mb-2">GÃ¼venli</h3>
            <p className="text-[#A0A0A0] text-sm">
              API anahtarlarÄ±nÄ±z ÅŸifrelenmiÅŸ olarak saklanÄ±r
            </p>
          </div>
          <div className="bg-[#1E1E1E] rounded-xl p-6">
            <div className="text-3xl mb-3">ðŸ’°</div>
            <h3 className="text-white font-bold mb-2">Kendi BÃ¼tÃ§eniz</h3>
            <p className="text-[#A0A0A0] text-sm">
              Kendi API anahtarÄ±nÄ±zÄ± kullanÄ±n, kendi bÃ¼tÃ§enizi kontrol edin
            </p>
          </div>
          <div className="bg-[#1E1E1E] rounded-xl p-6">
            <div className="text-3xl mb-3">âš¡</div>
            <h3 className="text-white font-bold mb-2">HÄ±zlÄ±</h3>
            <p className="text-[#A0A0A0] text-sm">
              DoÄŸrudan AI saÄŸlayÄ±cÄ±sÄ±na baÄŸlanÄ±n, aracÄ± yok
            </p>
            </div>
          </div>
        )}
      </div>

      {/* Add Modal */}
      {showAddModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-[#1E1E1E] rounded-xl p-6 max-w-md w-full">
            <h2 className="text-white text-xl font-bold mb-4">AI Entegrasyonu Ekle</h2>
            
            <form onSubmit={handleAddIntegration}>
              <div className="mb-4">
                <label className="text-white text-sm font-medium mb-2 block">
                  AI SaÄŸlayÄ±cÄ±sÄ±
                </label>
                <select
                  value={selectedProvider}
                  onChange={(e) => {
                    setSelectedProvider(e.target.value);
                    setSelectedModel('');
                  }}
                  className="w-full bg-[#2C2C2C] text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#30D158]"
                  required
                >
                  <option value="">SeÃ§in...</option>
                  {AI_PROVIDERS.map((provider) => (
                    <option key={provider.id} value={provider.id}>
                      {provider.icon} {provider.name}
                    </option>
                  ))}
                </select>
              </div>

              {selectedProvider && (
                <div className="mb-4">
                  <label className="text-white text-sm font-medium mb-2 block">
                    Model (Opsiyonel)
                  </label>
                  <select
                    value={selectedModel}
                    onChange={(e) => setSelectedModel(e.target.value)}
                    className="w-full bg-[#2C2C2C] text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#30D158]"
                  >
                    <option value="">VarsayÄ±lan</option>
                    {AI_PROVIDERS.find(p => p.id === selectedProvider)?.models.map((model) => (
                      <option key={model} value={model}>
                        {model}
                      </option>
                    ))}
                  </select>
                </div>
              )}

              <div className="mb-6">
                <label className="text-white text-sm font-medium mb-2 block">
                  API AnahtarÄ±
                </label>
                <input
                  type="password"
                  value={apiKey}
                  onChange={(e) => setApiKey(e.target.value)}
                  placeholder="sk-..."
                  className="w-full bg-[#2C2C2C] text-white rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#30D158]"
                  required
                />
                <p className="text-[#666] text-xs mt-2">
                  API anahtarÄ±nÄ±z ÅŸifrelenmiÅŸ olarak saklanÄ±r
                </p>
              </div>

              <div className="flex gap-3">
                <button
                  type="button"
                  onClick={() => setShowAddModal(false)}
                  className="flex-1 bg-[#2C2C2C] text-white py-3 rounded-xl font-medium hover:bg-[#3C3C3C] transition"
                >
                  Ä°ptal
                </button>
                <button
                  type="submit"
                  className="flex-1 bg-[#30D158] text-white py-3 rounded-xl font-medium hover:bg-[#28a745] transition"
                >
                  Ekle
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}
