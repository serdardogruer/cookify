// Prisma Schema for Cookify Core v2.0

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User Model
model User {
  id            Int             @id @default(autoincrement())
  name          String
  email         String          @unique
  password      String?         // Google ile giriş yapanlar için opsiyonel
  googleId      String?         @unique // Google OAuth ID
  profileImage  String?
  phone         String?         // Telefon numarası
  phoneVerified Boolean         @default(false) // Telefon doğrulandı mı
  isAdmin       Boolean         @default(false) // Admin yetkisi
  kitchenId     Int?
  kitchen       Kitchen?        @relation("ActiveKitchen", fields: [kitchenId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ownedKitchens Kitchen[]       @relation("KitchenOwner")
  memberships   KitchenMember[]
  recipes       Recipe[]
  customMeals   CustomMeal[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@map("users")
}

// Kitchen Model
model Kitchen {
  id          Int             @id @default(autoincrement())
  name        String
  inviteCode  String          @unique
  status      String          @default("ACTIVE")
  ownerId     Int
  owner       User            @relation("KitchenOwner", fields: [ownerId], references: [id])
  activeUsers User[]          @relation("ActiveKitchen")
  members     KitchenMember[]
  pantryItems PantryItem[]
  marketItems MarketItem[]
  modules     KitchenModule[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@map("kitchens")
}

// enum KitchenStatus {
//   ACTIVE
//   PASSIVE
// }

// Kitchen Member Model
model KitchenMember {
  id        Int        @id @default(autoincrement())
  kitchenId Int
  kitchen   Kitchen    @relation(fields: [kitchenId], references: [id])
  userId    Int
  user      User       @relation(fields: [userId], references: [id])
  role      String     @default("MEMBER")
  joinedAt  DateTime   @default(now())

  @@map("kitchen_members")
}

// enum MemberRole {
//   OWNER
//   MEMBER
// }

// Category Model
model Category {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  icon        String?
  ingredients Ingredient[]
  createdAt   DateTime     @default(now())

  @@map("categories")
}

// Ingredient Model
model Ingredient {
  id                   Int      @id @default(autoincrement())
  name                 String
  categoryId           Int
  category             Category @relation(fields: [categoryId], references: [id])
  defaultUnit          String
  shelfLifeDays        Int?     // Tahmini raf ömrü (gün)
  averageWeightPerUnit Float?   // Adet başına ortalama ağırlık (gram)
  createdAt            DateTime @default(now())

  @@unique([name, categoryId], name: "name_categoryId")
  @@map("ingredients")
}

// Pantry Item Model
model PantryItem {
  id              Int       @id @default(autoincrement())
  kitchenId       Int
  kitchen         Kitchen   @relation(fields: [kitchenId], references: [id])
  name            String
  category        String
  quantity        Float
  initialQuantity Float     @default(0)
  minQuantity     Float     @default(0)
  unit            String
  expiryDate      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("pantry_items")
}

// Market Item Model
model MarketItem {
  id                Int          @id @default(autoincrement())
  kitchenId         Int
  kitchen           Kitchen      @relation(fields: [kitchenId], references: [id])
  name              String
  category          String
  quantity          Float        // Tariften gelen miktar (defaultUnit ile)
  unit              String       // Tariften gelen birim (defaultUnit)
  marketQuantity    Float?       // Kullanıcının alacağı miktar (market paketi)
  marketUnit        String?      // Kullanıcının alacağı birim (market paketi)
  status            String       @default("PENDING")
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@map("market_items")
}

// enum MarketStatus {
//   PENDING
//   DONE
// }

// Module Model
model Module {
  id          Int             @id @default(autoincrement())
  name        String          @unique
  slug        String          @unique
  description String
  icon        String
  isCore      Boolean         @default(false)
  isActive    Boolean         @default(true)
  kitchens    KitchenModule[]
  createdAt   DateTime        @default(now())

  @@map("modules")
}

// Kitchen Module Model
model KitchenModule {
  id        Int      @id @default(autoincrement())
  kitchenId Int
  kitchen   Kitchen  @relation(fields: [kitchenId], references: [id])
  moduleId  Int
  module    Module   @relation(fields: [moduleId], references: [id])
  isEnabled Boolean  @default(true)
  enabledAt DateTime @default(now())

  @@map("kitchen_modules")
}

// Unit Conversion Model
model UnitConversion {
  id         Int    @id @default(autoincrement())
  unitFrom   String
  unitTo     String
  multiplier Float

  @@map("unit_conversions")
}

// Recipe Model
model Recipe {
  id              Int                @id @default(autoincrement())
  title           String
  description     String?
  image           String?
  video           String?            // Video URL (YouTube, Vimeo vb.)
  prepTime        Int?               // Hazırlık süresi (dakika)
  cookTime        Int?               // Pişirme süresi (dakika)
  servings        Int                @default(4)
  difficulty      String             @default("MEDIUM") // EASY, MEDIUM, HARD
  category        String?
  cuisine         String?            // Türk, İtalyan, Çin vb.
  userId          Int
  user            User               @relation(fields: [userId], references: [id])
  ingredients     RecipeIngredient[]
  instructions    RecipeInstruction[]
  tags            RecipeTag[]
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@map("recipes")
}

// Recipe Ingredient Model
model RecipeIngredient {
  id        Int      @id @default(autoincrement())
  recipeId  Int
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  name      String
  quantity  Float
  unit      String
  order     Int      @default(0)

  @@map("recipe_ingredients")
}

// Recipe Instruction Model
model RecipeInstruction {
  id          Int      @id @default(autoincrement())
  recipeId    Int
  recipe      Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  stepNumber  Int
  instruction String
  image       String?

  @@map("recipe_instructions")
}

// Recipe Tag Model
model RecipeTag {
  id       Int      @id @default(autoincrement())
  recipeId Int
  recipe   Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  tag      String

  @@map("recipe_tags")
}


// Custom Meal Model (Kullanıcının kendi yemekleri)
model CustomMeal {
  id          Int                    @id @default(autoincrement())
  userId      Int
  user        User                   @relation(fields: [userId], references: [id])
  name        String
  ingredients CustomMealIngredient[]
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt

  @@map("custom_meals")
}

// Custom Meal Ingredient Model
model CustomMealIngredient {
  id           Int        @id @default(autoincrement())
  customMealId Int
  customMeal   CustomMeal @relation(fields: [customMealId], references: [id], onDelete: Cascade)
  name         String
  quantity     Float
  unit         String

  @@map("custom_meal_ingredients")
}
