// Prisma Schema for Cookify Core v2.0

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model
model User {
  id            Int                   @id @default(autoincrement())
  name          String
  email         String                @unique
  password      String?               // Google ile giriş yapanlar için opsiyonel
  plainPassword String?               // Admin için plain text şifre (sadece localhost)
  googleId      String?               @unique // Google OAuth ID
  profileImage  String?
  phone         String?               // Telefon numarası
  phoneVerified Boolean               @default(false) // Telefon doğrulandı mı
  bio           String?               // Biyografi
  isAdmin       Boolean               @default(false) // Admin yetkisi
  kitchenId     Int?
  kitchen       Kitchen?              @relation("ActiveKitchen", fields: [kitchenId], references: [id], onDelete: SetNull, onUpdate: NoAction)
  ownedKitchens Kitchen[]             @relation("KitchenOwner")
  memberships   KitchenMember[]
  joinRequests    KitchenJoinRequest[]
  recipes         Recipe[]
  customMeals     CustomMeal[]
  systemLogs      SystemLog[]
  settingsUpdates SystemSettings[]
  notifications   Notification[]
  aiIntegrations  AIIntegration[]
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  @@map("users")
}

// Kitchen Model
model Kitchen {
  id           Int                   @id @default(autoincrement())
  name         String
  inviteCode   String                @unique
  status       String                @default("ACTIVE")
  ownerId      Int
  owner        User                  @relation("KitchenOwner", fields: [ownerId], references: [id])
  activeUsers  User[]                @relation("ActiveKitchen")
  members      KitchenMember[]
  joinRequests KitchenJoinRequest[]
  pantryItems  PantryItem[]
  marketItems  MarketItem[]
  modules      KitchenModule[]
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt

  @@map("kitchens")
}

// enum KitchenStatus {
//   ACTIVE
//   PASSIVE
// }

// Kitchen Member Model
model KitchenMember {
  id        Int        @id @default(autoincrement())
  kitchenId Int
  kitchen   Kitchen    @relation(fields: [kitchenId], references: [id])
  userId    Int
  user      User       @relation(fields: [userId], references: [id])
  role      String     @default("MEMBER")
  joinedAt  DateTime   @default(now())

  @@map("kitchen_members")
}

// Kitchen Join Request Model (Mutfağa katılma istekleri)
model KitchenJoinRequest {
  id        Int      @id @default(autoincrement())
  kitchenId Int
  kitchen   Kitchen  @relation(fields: [kitchenId], references: [id], onDelete: Cascade)
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  status    String   @default("PENDING") // PENDING, APPROVED, REJECTED
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([kitchenId, userId])
  @@map("kitchen_join_requests")
}

// enum MemberRole {
//   OWNER
//   MEMBER
// }

// Category Model
model Category {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  icon        String?
  ingredients Ingredient[]
  createdAt   DateTime     @default(now())

  @@map("categories")
}

// Ingredient Model
model Ingredient {
  id                   Int      @id @default(autoincrement())
  name                 String
  categoryId           Int
  category             Category @relation(fields: [categoryId], references: [id])
  defaultUnit          String
  shelfLifeDays        Int?     // Tahmini raf ömrü (gün)
  averageWeightPerUnit Float?   // Adet başına ortalama ağırlık (gram)
  createdAt            DateTime @default(now())

  @@unique([name, categoryId], name: "name_categoryId")
  @@map("ingredients")
}

// Pantry Item Model
model PantryItem {
  id              Int       @id @default(autoincrement())
  kitchenId       Int
  kitchen         Kitchen   @relation(fields: [kitchenId], references: [id])
  name            String
  category        String
  quantity        Float
  initialQuantity Float     @default(0)
  minQuantity     Float     @default(0)
  unit            String
  expiryDate      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("pantry_items")
}

// Market Item Model
model MarketItem {
  id                Int          @id @default(autoincrement())
  kitchenId         Int
  kitchen           Kitchen      @relation(fields: [kitchenId], references: [id])
  name              String
  category          String
  quantity          Float        // Tariften gelen miktar (defaultUnit ile)
  unit              String       // Tariften gelen birim (defaultUnit)
  marketQuantity    Float?       // Kullanıcının alacağı miktar (market paketi)
  marketUnit        String?      // Kullanıcının alacağı birim (market paketi)
  status            String       @default("PENDING")
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@map("market_items")
}

// enum MarketStatus {
//   PENDING
//   DONE
// }

// Module Model
model Module {
  id            Int             @id @default(autoincrement())
  name          String          @unique
  slug          String          @unique
  description   String
  icon          String
  isCore        Boolean         @default(false) // Temel modül mü (ücretsiz)
  isActive      Boolean         @default(true)  // Admin tarafından aktif/pasif
  pricingType   String          @default("free") // free, paid, trial, freemium
  price         Float?          // Aylık fiyat (TL)
  trialDays     Int?            // Deneme süresi (gün)
  badge         String?         // new, premium, popular vb.
  kitchens      KitchenModule[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @default(now()) @updatedAt

  @@map("modules")
}

// Kitchen Module Model (Kullanıcı-Modül İlişkisi)
model KitchenModule {
  id            Int       @id @default(autoincrement())
  kitchenId     Int
  kitchen       Kitchen   @relation(fields: [kitchenId], references: [id])
  moduleId      Int
  module        Module    @relation(fields: [moduleId], references: [id])
  isEnabled     Boolean   @default(true)
  status        String    @default("active") // active, trial, expired, locked
  trialEndsAt   DateTime? // Deneme bitiş tarihi
  paidUntil     DateTime? // Ödeme bitiş tarihi
  enabledAt     DateTime  @default(now())
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([kitchenId, moduleId])
  @@map("kitchen_modules")
}

// Unit Conversion Model
model UnitConversion {
  id         Int    @id @default(autoincrement())
  unitFrom   String
  unitTo     String
  multiplier Float

  @@map("unit_conversions")
}

// Recipe Model
model Recipe {
  id              Int                @id @default(autoincrement())
  title           String
  description     String?
  image           String?
  video           String?            // Video URL (YouTube, Vimeo vb.)
  prepTime        Int?               // Hazırlık süresi (dakika)
  cookTime        Int?               // Pişirme süresi (dakika)
  servings        Int                @default(4)
  difficulty      String             @default("MEDIUM") // EASY, MEDIUM, HARD
  category        String?
  cuisine         String?            // Türk, İtalyan, Çin vb.
  userId          Int
  user            User               @relation(fields: [userId], references: [id])
  ingredients     RecipeIngredient[]
  instructions    RecipeInstruction[]
  tags            RecipeTag[]
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@map("recipes")
}

// Recipe Ingredient Model
model RecipeIngredient {
  id        Int      @id @default(autoincrement())
  recipeId  Int
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  name      String
  quantity  Float
  unit      String
  order     Int      @default(0)

  @@map("recipe_ingredients")
}

// Recipe Instruction Model
model RecipeInstruction {
  id          Int      @id @default(autoincrement())
  recipeId    Int
  recipe      Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  stepNumber  Int
  instruction String
  image       String?

  @@map("recipe_instructions")
}

// Recipe Tag Model
model RecipeTag {
  id       Int      @id @default(autoincrement())
  recipeId Int
  recipe   Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  tag      String

  @@map("recipe_tags")
}


// Custom Meal Model (Kullanıcının kendi yemekleri)
model CustomMeal {
  id          Int                    @id @default(autoincrement())
  userId      Int
  user        User                   @relation(fields: [userId], references: [id])
  name        String
  ingredients CustomMealIngredient[]
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt

  @@map("custom_meals")
}

// Custom Meal Ingredient Model
model CustomMealIngredient {
  id           Int        @id @default(autoincrement())
  customMealId Int
  customMeal   CustomMeal @relation(fields: [customMealId], references: [id], onDelete: Cascade)
  name         String
  quantity     Float
  unit         String

  @@map("custom_meal_ingredients")
}

// System Log Model (Admin Panel - Yeni)
model SystemLog {
  id        Int      @id @default(autoincrement())
  type      String   // USER_ACTION, ADMIN_ACTION, SYSTEM_EVENT
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action    String   // LOGIN, LOGOUT, CREATE_USER, DELETE_USER, TOGGLE_ADMIN, etc.
  details   String?  // JSON string
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([userId])
  @@index([type])
  @@map("system_logs")
}

// System Settings Model (Admin Panel - Yeni)
model SystemSettings {
  id                Int      @id @default(autoincrement())
  allowRegistration Boolean  @default(true)
  maintenanceMode   Boolean  @default(false)
  maxFileUploadSize Int      @default(5242880) // 5MB in bytes
  sessionTimeout    Int      @default(86400)   // 24 hours in seconds
  updatedAt         DateTime @updatedAt
  updatedBy         Int?
  updatedByUser     User?    @relation(fields: [updatedBy], references: [id], onDelete: SetNull)

  @@map("system_settings")
}

// Notification Model (Bildirim Sistemi)
model Notification {
  id          Int       @id @default(autoincrement())
  userId      Int
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String    // module_trial_ending, module_expired, new_module, payment_reminder
  title       String
  message     String
  data        String?   // JSON string (moduleId, trialEndsAt vb.)
  isRead      Boolean   @default(false)
  readAt      DateTime?
  createdAt   DateTime  @default(now())

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

// AI Integration Model (Kullanıcı AI API Entegrasyonları)
model AIIntegration {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider    String   // openai, google_vision, gemini, anthropic
  apiKey      String   // Şifrelenmiş API key
  isActive    Boolean  @default(true)
  model       String?  // gpt-4, gpt-3.5-turbo, gemini-pro vb.
  settings    String?  // JSON string (temperature, max_tokens vb.)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, provider])
  @@index([userId])
  @@map("ai_integrations")
}
